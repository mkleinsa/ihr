---
title: "Getting Started in ihr"
author: "Owen Yoo, Shuiqing Han, Irina Gaynanova"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting Started in ihr}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, include = FALSE}
library(ihr)
```

The ihr package is designed to help in the analyses of heart rate data from wearable technologies (i.e. FitBit, Apple Watches, etc.). These wearable technologies capture the heart rate of the user while the user is wearing the device, often in intervals of only a couple of seconds. Wearable technologies commonly track heart rate using Photoplethysmography (PPG). Data from these wearable are increasingly used to understand a users physical activity and their heart functionality on a day by day basis. 

The ihr package is unique in its ability to measure various types of metric that would be of interest to clinicians, each metric being designed to be outputted with one line of code. In addition, many ihr metrics are inspired by metrics commonly used for continuous glucose monitoring (CGM), which transfers well to heart rate  data due to the similarity in the structure of the data.

The ihr package is designed to work with a data frame object that have the three columns present:

* Heart Rate Measurement (in Beats per Minute) (`"hr"`)

* Timestamp for Measurement (`"time"`)

* Subject identification (`"id"`)

ihr comes with example data from 14 subjects whose heart rate were tracked with FitBit devices. This data is publicly available from [kaggle](https://www.kaggle.com/datasets/arashnic/fitbit/versions/1/data)

# Example Datasets
The ihr package includes two datasets: example_heart_1, and example_heart_14. The one subject data is simply the first subject of the 14 subject data. 

## Example data for 1 subject

Example data with 1 subject can be loaded with:

```{r}
data("example_heart_1")
```
  
This dataset contains 154104 observations of 3 columns corresponding to the three components listed in the introduction:

* `"id"` - Factor (character string) column for subject identification
* `"time"` - POSIXct column for datetime values
* `"hr"` - Numeric column for heart rate
Data used with ihr functions may have additional columns, but the columns for id, time and hr values must be named as above.

```{r}
dim(example_heart_1)
str(example_heart_1)
head(example_heart_1)
```

# Summarizing Data

The ihr package provides summary of heart rate data, it returns multiple values using basic function.

```{r}
summary_hr(example_heart_1)
```

# Vizualizing Data

The `plot_glu` function generates a time series plot. This function can support both single and multiple subjects.

```{r fig.width= 7}
plot_hr(example_heart_1)
```

`plot_hr` also supports additional arguments to adjust the way the heart rate data can be plotted. 

Due to the massive number of observations that heart rate data can have, `plot_hr` supports a time range argument. Using `from` and `to`, the function will plot the heart rate data only from the specified time interval [from, to). If an argument is not provided to one of the two, the function defaults to the first and last observation, respectively. 

```{r fig.width= 7}
plot_hr(example_heart_1, from = "2016-04-30", to = "2016-05-02")
```

The red lines can be shifted to any Lower or Upper Heart Rate using the parameter `LHR` and `UHR` respectively.

```{r fig.width= 7}
plot_hr(example_heart_1, LHR = 100, UHR = 120)
```

Finally, `plot_hr` supports a time aggregation argument. Using the parameter `agg`, users can specify if the plot should be plotted using minute or hour long summary for heart rate. If the user chooses to use `agg`, the `inter_gap` argument must be adjusted accordingly, where `inter_gap` must be equal to or longer than the aggregated time in seconds.

```{r fig.width= 7}
plot_hr(example_heart_1, to = "2016-04-13", agg = "minute")
```

# Calculating time-dependent metrics

The ihr package have the function of calculating multiple time-dependent metrics.

## active_percent()

The function computes the active percentage, representing the percentage missingness of the heart rate data. 

The resulting output is a structured table where:

Id represents the subject.
start_date and end_date mark the observation period.
unique_days counts the actual days with recorded data.
total_days indicates the full monitoring period(including both start and end date).
active_percent represents the completeness of heart rate recordings as a percentage at the day level.

```{r}
active_percent(example_heart_1)
```

# MAHE (Mean Amplitude of Heart Rate Excursions)

MAHE is a variability based metric that is influenced by a similar metric used in continuous glucode monitoring. The algorithm used for this metric is used from the open-source algorithm provided in [Open-Source Algorithm to Calculate Mean Amplitude of Glycemic Excursions Using Short and Long Moving Averages](https://journals.sagepub.com/doi/10.1177/19322968211061165).

`mahe` supports calculation for single or multiple subjects and returns a data frame with columns `id` and `MAHE`. Other parameters adjust the calculation of the algorithm.

```{r}
mahe(example_heart_1)
```

## Example plot: MAHE

`mahe` supports a plotting argument that creates a heart rate trace plot that highlights the selected peaks and nadirs that are used in the MAHE calculation. This plot must be specified with the `plot` argument. Additionally, users can show the moving averages using `show_ma` and the excursions with `show_excursions`

```{r fig.width = 7}
mahe(example_heart_1, to = "2016-04-13", plot = T, show_ma = T, show_excursions = T)
```

# Introduction to episodes

## Episode_calculation

The episode_calculation function identifies episodes where heart rate (HR) exceed predefined thresholds. It classifies each data point as:

Low Episode: Heart rate falls below a given threshold.
High Episode: Heart rate rises above a given threshold.
Exclusive Episodes: An episode that remains within Level 1 (lv1) and never reaches Level 2 (lv2).
Level 2 represents a more extreme states that level 1.
Extended Episodes: Prolonged episodes that meet a minimum duration criterion.

For each episode, the function computes summary statistics, including:
1. Average episodes per day.
2. Mean episode duration.
3. Mean HR levels during episodes.
4. Total number of episodes.

```{r}
episode_calculation(example_heart_1, lv1_low = 60, lv2_low = 55, lv1_high = 85, lv2_high = 100, dur_length = 15)
```

## Epicalc_profile: Visualizing Episode Trends

While episode_calculation identifies and summarizes episodes, epicalc_profile provides a visualization of episode trends over time. It generates:

1. A summary table displaying key episode metrics.
2. A scatter plot of heart rate values over time, with each data point color-coded by episode classification.

### Example plot for epicalc_profile

```{r fig.width= 8, fig.height = 6}
epicalc_profile(example_heart_1)
```

