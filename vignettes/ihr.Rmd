---
title: "Getting Started in ihr"
author: "Owen Yoo, Shuiqing Han, Irina Gaynanova"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting Started in ihr}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, include = FALSE}
library(ihr)
```

The ihr package is designed to help in the analyses of heart rate data from wearable technologies (i.e. FitBit, Apple Watches, etc.). These wearable technologies capture the heart rate of the user while the user is wearing the device, often in intervals of only a couple of seconds. Wearable technologies commonly track heart rate using photoplethysmography (PPG). Data from these wearable are increasingly used to understand a user's physical activity and their heart functionality on a day-by-day basis. The ability to capture heart rate data in an easy and widespread manners make these technologies appealing, and methods for analyzing these data are needed for better understanding of a subject's heart health.

The ihr package is unique in its ability to measure various types of metrics that would be of interest to clinicians, each metric being designed to be outputted with one line of code. In addition, many ihr metrics are inspired by metrics commonly used for continuous glucose monitoring (CGM), which transfers well to heart rate data due to the similarity in the structure of the data.

The ihr package is designed to work with a data frame object that have the three columns present:

* Heart Rate Measurement (in Beats per Minute) (`"hr"`)

* Timestamp for Measurement (`"time"`)

* Subject identification (`"id"`)

ihr comes with example data from 5 subjects whose heart rate were tracked with FitBit devices. This data is publicly available from [kaggle](https://www.kaggle.com/datasets/arashnic/fitbit/versions/1/data)

# Example Datasets
The ihr package includes two datasets: `example_heart_1`, and `example_heart_5`. The one subject data is simply the first subject of the 5 subject data. 

## Example data for 1 subject

Example data with 1 subject can be loaded with:

```{r}
data("example_heart_1")
```
  
This dataset contains 154104 observations of 3 columns corresponding to the three components listed in the introduction:

* `"id"` - Factor (character string) column for subject identification
* `"time"` - POSIXct column for datetime values
* `"hr"` - Numeric column for heart rate
Data used with ihr functions may have additional columns, but the columns for id, time and hr values must be named as above.

```{r}
dim(example_heart_1)
str(example_heart_1)
head(example_heart_1)
```

# Summarizing Data

The ihr package provides summaries of heart rate data in an easy and intuitive manner using `summary_hr`. This function returns multiple summary statistics (including mean, median, and standard deviation) for a given heart rate data.

```{r}
summary_hr(example_heart_1)
```

# Visualizing Data

The ihr package supports the following plotting functions:

| Function call | Visualization description |
|:------------|:------------------------------|
|`plot_hr` | Standard time series based line plot | 
|`scatter_roc`| Scatter Plot of rate of change (ROC) and Heart Rate| 
|`hist_roc` | Histogram of rate of change (ROC) values | 
|`plot_daily` | Daily heart rate profile for a single subject | 
|`plot_ahp` | 24 Hour heart rate summary plot for a single subject | 
|`plot_ranges_PA` | Distribution of Activity | 
|`ahp` | Ambulatory Heart Rate Profile (AHP) | 
|`epicalc_profile` | Profile of heart rate episodes | 
|`mahe` | MAHE plot displaying peaks and nadirs | 

The time series plots will be detailed below.

## Example Plots: Time Series

The `plot_hr` function generates a time series plot. This function can support both single and multiple subjects.

```{r fig.width= 7}
plot_hr(example_heart_1)
```

`plot_hr` also supports additional arguments to adjust the way the heart rate data can be plotted. 

Due to the massive number of observations that heart rate data can have, `plot_hr` supports a time range argument. Using `from` and `to`, the function will plot the heart rate data only from the specified time interval [from, to). If an argument is not provided to one of the two, the function defaults to the first and last observation, respectively. 

```{r fig.width= 7}
plot_hr(example_heart_1, from = "2016-04-30", to = "2016-05-02")
```

The red lines can be shifted to any Lower or Upper Heart Rate using the parameter `LHR` and `UHR` respectively.

```{r fig.width= 7}
plot_hr(example_heart_1, LHR = 100, UHR = 120)
```

Finally, `plot_hr` supports a time aggregation argument. Using the parameter `agg`, users can specify if the plot should be plotted using minute or hour long summary for heart rate. If the user chooses to use `agg`, the `inter_gap` argument must be adjusted accordingly, where `inter_gap` must be equal to or longer than the aggregated time in seconds.

```{r fig.width= 7}
plot_hr(example_heart_1, to = "2016-04-13", agg = "minute")
```

# Calculating time-dependent metrics

The ihr package have the function of calculating multiple time-dependent metrics.

## percent_nonmissing()

`percent_nonmissing` computes the active percentage, representing the percentage missingness of the heart rate data. 

The resulting output is a structured table where:

* id represents the subject.
* start_time and end_time mark the observation period.
* unique_days counts the actual days with recorded data.
* total_days indicates the full monitoring period(including both start and end date).
* percent_nonmissing represents the completeness of heart rate recordings as a percentage at the minute level.

```{r}
percent_nonmissing(example_heart_1)
```

# MAHE (Mean Amplitude of Heart Rate Excursions)

MAHE is a variability based metric that is influenced by a similar metric used in continuous glucose monitoring. The algorithm used for this metric is from the open-source algorithm provided in [Open-Source Algorithm to Calculate Mean Amplitude of Glycemic Excursions Using Short and Long Moving Averages](https://journals.sagepub.com/doi/10.1177/19322968211061165).

`mahe` supports calculation for single or multiple subjects and returns a data frame with columns `id` and `MAHE`. Other parameters adjust the calculation of the algorithm and the return type that the function can support. `mahe` can support return types of either segment long `MAHE` values (using `return_type = "df-seg`) or excursion level amplitude values (using `return_type = "df-exc`)

```{r}
mahe(example_heart_1)
```

## Example plot: MAHE

`mahe` supports a plotting argument that creates a heart rate trace plot that highlights the selected peaks and nadirs that are used in the MAHE calculation. This plot must be specified with the `plot` argument. Additionally, users can show the moving averages using `show_ma` and the excursions with `show_excursions`

```{r fig.width = 7}
mahe(example_heart_1, to = "2016-04-13", plot = T, show_ma = T, show_excursions = T)
```

# Introduction to episodes

## What are episodes?

Episodes are defined as distinct periods of times within a subject's heart rate where the heart rate exceeds or is between a certain threshold for a certain amount of time. This metric is inspired from a similarly structured metric in CGM. 

## Episode_calculation

`episode_calculation` identifies episodes where heart rate (HR) exceed predefined thresholds. It classifies each data point as:

sedentary/sleep (<20% HRR), light (20–39% HRR), moderate (40–59% HRR), and vigorous (≥60% HRR)

For each episode, the function computes summary statistics, including:
1. Average episodes per day.
2. Mean episode duration.
3. Mean HR levels during episodes.
4. Total number of episodes.

```{r}
episode_calculation(example_heart_1)
```

## Epicalc_profile: Visualizing Episode Trends

While episode_calculation identifies and summarizes episodes, `epicalc_profile` provides a visualization of episode trends over time. It generates:

1. A summary table displaying key episode metrics.
2. A scatter plot of heart rate values over time, with each data point color-coded by episode classification.

### Example plot for epicalc_profile

```{r fig.width= 8, fig.height = 6}
epicalc_profile(example_heart_1)
```

