---
title: "Getting Started in ihr"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting Started in ihr}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, include = FALSE}
library(ihr)
```

The ihr package is designed to help in the analyses of heart rate data from wearable technologies (i.e. FitBit, Apple Watches, etc.). These wearable technologies capture the heart rate of the user while the user is wearing the device, often in intervals of only a couple of seconds. Data from these wearables are increasingly used to understand a users physical activity and their heart functionality on a day by day basis. 

Previous R packages on heart rate are typically more narrow in their focus. Whether it be more specific on one type of metric (such as heart rate variability) or a specific event that these devices capture (Physical exertion). The ihr package is unique in its ability to measure various types of metric that would be of interest to clinicians, each metric being designed to be outputted with one line of code. In addition, many ihr metrics are inspired by metrics commonly used for continuous glucose monitoring (CGM), which transfers well to heart rate centered data.

The ihr package is designed to work with a data frame object that have the three columns present:

* Heart Rate Measurement (in Beats per Minute) (`"hr"`)

* Timestamp for Measurement (`"time"`)

* Subject identification (`"id"`)

ihr comes with example data from 5 subjects whose heart rate were tracked with FitBit devices. This data is publically available from ![kaggle](https://www.kaggle.com/datasets/arashnic/fitbit/versions/1/data)

# Example Datasets
The ihr package includes two datasets: example_heart_1, and example_heart_5. The one subject data is simply the first subject of the five subject data. 

## Example data for 1 subject

Example data with 1 subject can be loaded with:

```{r}
data("example_heart_1")
```
  
This dataset contains 154104 observations of 3 columns corresponding to the three components listed in the introduction:

* `"id"` - Factor (character string) column for subject identification
* `"time"` - POSIXct column for datetime values
* `"hr"` - Numeric column for heart rate
Data used with ihr functions may have additional columns, but the columns for id, time and hr values must be named as above.

```{r}
dim(example_heart_1)
str(example_heart_1)
head(example_heart_1)
```

# Summarizing Data

The ihr package provides summary of heart rate data, it returns multiple values using basic function.

```{r}
summary_hr(example_heart_1)
```

# Calculating time-dependent metrics

The ihr package have the function of calculating multiple time-dependent metrics.

## active_percent()

When a dataframe is passed, subject id will always be printed in the id column, and multiple values for a single subject will be printed in the following columns.

```{r}
active_percent(example_heart_1)
```

## episode_calculation()

This function calculates low and high heart rate episodes with summary statistics. 

```{r}
episode_calculation(example_heart_1, lv1_low = 60, lv2_low = 55, lv1_high = 85, lv2_high = 100, dur_length = 15)
```


### Parameters

#### data 
DataFrame object with column names "id", "time", and "hr". 

#### lv1_low, lv2_low, hy1_high, lv2_high
Users can set certain thresholds for the low and high heart rate by passing parameters, lv1_low, lv2_low, lv1_high, lv2_high. Level 2 indicates more extreme states than level 1 so the threshold value for the lv2_low value should be lower than lv1_low value, and the threshold for the lv2_high value should higher than lv1_high value.

#### dur_length
By setting a duration length to 15 minutes (the last parameter), the function will count the number of episodes that heart rate values go below or above the thresholds more than 15 minutes. 


### Return Value

For each single subject, it returns a dataframe including average number of episodes per day, average episode length, and average heart rate in episodes for each type and each level.

# MAHE (Mean Amplitude of Heart Rate Excursions)

MAHE is a variability based metric that is influenced by a similar metric used in continuous glucode monitoring. The algorithm used for this metric is used from the open-source algorithm provided in ![Open-Source Algorithm to Calculate Mean Amplitude of Glycemic Excursions Using Short and Long Moving Averages](https://journals.sagepub.com/doi/10.1177/19322968211061165).

`mahe` supports calculation for single or multiple subjects and returns a data frame with columns `id` and `MAHE`. Other parameters adjust the calculation of the algorithm and additional plotting options (further detailed below)

```{r}
mahe(example_heart_1)
```


# Vizualizations

The ihr package supports two plot types described below:

| Function call | Visualization description | 
|:------------|:------------------------------|
|`plot_hr` | Time Series plot of Heart Rate | 
|`mahe`| MAHE plot displying peak and nadirs| 

## Example plot: Time series

The `plot_glu` function generates a time series plot. This function can support both single and multiple subjects.

```{r fig.width= 7}
plot_hr(example_heart_1)
```

`plot_hr` also supports additional arguments to adjust the way the heart rate data can be plotted. 

Due to the sheer number of observations that heart rate can have, `plot_hr` supports a time range argument. Using `from` and `to`, the function will plot the heart rate data only from the specified time interval [from, to). If an argument is not provided to one of the two, the function defaults to the first and last observation, respectively. 

```{r fig.width= 7}
plot_hr(example_heart_1, to = "2016-04-13")
```

```{r fig.width= 7}
plot_hr(example_heart_1, from = "2016-04-30", to = "2016-05-02")
```

The red lines can be shifted to any Lower or Upper Heart Rate using the parameter `LHR` and `UHR` respectively

```{r fig.width= 7}
plot_hr(example_heart_1, LHR = 100, UHR = 120)
```

Finally, `plot_hr` supports a time aggregation argument. Using the parameter `agg`, users can specify if the plot should be plotted using minute or hour long summary for heart rate. If the user chooses to use `agg`, the `inter_gap` argument must be adjusted accordingly, where `inter_gap` must be equal to or longer than the aggregated time in seconds.

```{r fig.width= 7}
plot_hr(example_heart_1, to = "2016-04-13", agg = "minute")
```

```{r fig.width= 7}
plot_hr(example_heart_1, to = "2016-04-13", agg = "hour", inter_gap = 3600)
```

## Example plot: MAHE

`mahe` supports a plotting argument that creates a heart rate trace plot that highlights the selected peaks and nadirs that are used in the MAHE calculation. This plot must be specified with the `plot` argument. Additionally, users can show the moving averages using `show_ma` and the excursions with `show_excursions`

```{r}
mahe(example_heart_1, to = "2016-04-13", plot = T, show_ma = T, show_excursions = T)
```

